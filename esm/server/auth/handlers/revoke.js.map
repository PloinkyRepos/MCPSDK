{"version":3,"file":"revoke.js","sources":["../../../../../src/server/auth/handlers/revoke.ts"],"sourcesContent":["import { OAuthServerProvider } from '../provider.js';\nimport express, { RequestHandler } from 'express';\nimport cors from 'cors';\nimport { authenticateClient } from '../middleware/clientAuth.js';\nimport { OAuthTokenRevocationRequestSchema } from '../../../shared/auth.js';\nimport { rateLimit, Options as RateLimitOptions } from 'express-rate-limit';\nimport { allowedMethods } from '../middleware/allowedMethods.js';\nimport { InvalidRequestError, ServerError, TooManyRequestsError, OAuthError } from '../errors.js';\n\nexport type RevocationHandlerOptions = {\n    provider: OAuthServerProvider;\n    /**\n     * Rate limiting configuration for the token revocation endpoint.\n     * Set to false to disable rate limiting for this endpoint.\n     */\n    rateLimit?: Partial<RateLimitOptions> | false;\n};\n\nexport function revocationHandler({ provider, rateLimit: rateLimitConfig }: RevocationHandlerOptions): RequestHandler {\n    if (!provider.revokeToken) {\n        throw new Error('Auth provider does not support revoking tokens');\n    }\n\n    // Nested router so we can configure middleware and restrict HTTP method\n    const router = express.Router();\n\n    // Configure CORS to allow any origin, to make accessible to web-based MCP clients\n    router.use(cors());\n\n    router.use(allowedMethods(['POST']));\n    router.use(express.urlencoded({ extended: false }));\n\n    // Apply rate limiting unless explicitly disabled\n    if (rateLimitConfig !== false) {\n        router.use(\n            rateLimit({\n                windowMs: 15 * 60 * 1000, // 15 minutes\n                max: 50, // 50 requests per windowMs\n                standardHeaders: true,\n                legacyHeaders: false,\n                message: new TooManyRequestsError('You have exceeded the rate limit for token revocation requests').toResponseObject(),\n                ...rateLimitConfig\n            })\n        );\n    }\n\n    // Authenticate and extract client details\n    router.use(authenticateClient({ clientsStore: provider.clientsStore }));\n\n    router.post('/', async (req, res) => {\n        res.setHeader('Cache-Control', 'no-store');\n\n        try {\n            const parseResult = OAuthTokenRevocationRequestSchema.safeParse(req.body);\n            if (!parseResult.success) {\n                throw new InvalidRequestError(parseResult.error.message);\n            }\n\n            const client = req.client;\n            if (!client) {\n                // This should never happen\n                throw new ServerError('Internal Server Error');\n            }\n\n            await provider.revokeToken!(client, parseResult.data);\n            res.status(200).json({});\n        } catch (error) {\n            if (error instanceof OAuthError) {\n                const status = error instanceof ServerError ? 500 : 400;\n                res.status(status).json(error.toResponseObject());\n            } else {\n                const serverError = new ServerError('Internal Server Error');\n                res.status(500).json(serverError.toResponseObject());\n            }\n        }\n    });\n\n    return router;\n}\n"],"names":[],"mappings":";;;;;;;AAkBO,SAAS,kBAAkB,EAAE,UAAU,WAAW,mBAA6D;AAClH,MAAI,CAAC,SAAS,aAAa;AACvB,UAAM,IAAI,MAAM,gDAAgD;AAAA,EACpE;AAGA,QAAM,SAAS,QAAQ,OAAA;AAGvB,SAAO,IAAI,MAAM;AAEjB,SAAO,IAAI,eAAe,CAAC,MAAM,CAAC,CAAC;AACnC,SAAO,IAAI,QAAQ,WAAW,EAAE,UAAU,MAAA,CAAO,CAAC;AAGlD,MAAI,oBAAoB,OAAO;AAC3B,WAAO;AAAA,MACH,UAAU;AAAA,QACN,UAAU,KAAK,KAAK;AAAA;AAAA,QACpB,KAAK;AAAA;AAAA,QACL,iBAAiB;AAAA,QACjB,eAAe;AAAA,QACf,SAAS,IAAI,qBAAqB,gEAAgE,EAAE,iBAAA;AAAA,QACpG,GAAG;AAAA,MAAA,CACN;AAAA,IAAA;AAAA,EAET;AAGA,SAAO,IAAI,mBAAmB,EAAE,cAAc,SAAS,aAAA,CAAc,CAAC;AAEtE,SAAO,KAAK,KAAK,OAAO,KAAK,QAAQ;AACjC,QAAI,UAAU,iBAAiB,UAAU;AAEzC,QAAI;AACA,YAAM,cAAc,kCAAkC,UAAU,IAAI,IAAI;AACxE,UAAI,CAAC,YAAY,SAAS;AACtB,cAAM,IAAI,oBAAoB,YAAY,MAAM,OAAO;AAAA,MAC3D;AAEA,YAAM,SAAS,IAAI;AACnB,UAAI,CAAC,QAAQ;AAET,cAAM,IAAI,YAAY,uBAAuB;AAAA,MACjD;AAEA,YAAM,SAAS,YAAa,QAAQ,YAAY,IAAI;AACpD,UAAI,OAAO,GAAG,EAAE,KAAK,CAAA,CAAE;AAAA,IAC3B,SAAS,OAAO;AACZ,UAAI,iBAAiB,YAAY;AAC7B,cAAM,SAAS,iBAAiB,cAAc,MAAM;AACpD,YAAI,OAAO,MAAM,EAAE,KAAK,MAAM,kBAAkB;AAAA,MACpD,OAAO;AACH,cAAM,cAAc,IAAI,YAAY,uBAAuB;AAC3D,YAAI,OAAO,GAAG,EAAE,KAAK,YAAY,kBAAkB;AAAA,MACvD;AAAA,IACJ;AAAA,EACJ,CAAC;AAED,SAAO;AACX;"}